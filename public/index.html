<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Prabh's IPTV Master</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root { --accent: #00bfff; --bg: #0b0b0b; --card: #1a1a1a; --text: #eee; --master-width: 1200px; }
    body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    .container { width: 100%; max-width: var(--master-width); }
    h1 { color: var(--accent); text-align: center; text-transform: uppercase; letter-spacing: 3px; margin-bottom: 25px; }
    .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; width: 100%; justify-content: center; }
    button { padding: 12px 20px; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
    .btn-active { background: var(--accent) !important; color: black !important; box-shadow: 0 0 10px rgba(0, 191, 255, 0.4); }
    select, .search-wrapper input { padding: 12px; border-radius: 6px; border: 1px solid #333; background: var(--card); color: white; outline: none; }
    .search-wrapper { position: relative; display: flex; align-items: center; background: var(--card); border-radius: 6px; border: 1px solid #333; flex-grow: 1; max-width: 400px; }
    .search-wrapper input { border: none; width: 100%; padding-right: 40px; }
    .clear-btn { position: absolute; right: 10px; color: #888; cursor: pointer; font-weight: bold; display: none; font-size: 1.2rem; }
    #list { display: grid; grid-template-columns: repeat(6, 1fr); gap: 15px; height: 650px; overflow-y: auto; padding: 15px; background: #000; border-radius: 12px; border: 1px solid #222; margin-bottom: 25px; box-sizing: border-box; }
    .item { background: var(--card); border-radius: 8px; overflow: hidden; border: 1px solid #333; cursor: pointer; position: relative; min-height: 250px; display: flex; flex-direction: column; }
    .poster-container { width: 100%; aspect-ratio: 2/3; background: #111; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .item img { width: 100%; height: 100%; object-fit: cover; position: absolute; z-index: 1; opacity: 0; transition: opacity 0.3s; }
    .item img.loaded { opacity: 1; }
    .item-title { padding: 10px; font-size: 0.75rem; text-align: center; font-weight: bold; }
    .recent-tag { position: absolute; top: 8px; right: 8px; background: #e50914; color: white; font-size: 0.55rem; padding: 4px 8px; border-radius: 4px; font-weight: bold; z-index: 10; text-transform: uppercase; }
    .video-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; pointer-events: none; }
    .percent-text { font-size: 4rem; font-weight: 800; color: var(--accent); }
    .series-container { display: flex; height: calc(100% - 60px); background: #000; }
    .season-sidebar { width: 180px; background: #111; border-right: 1px solid #222; overflow-y: auto; display: flex; flex-direction: column; flex-shrink: 0; }
    .season-btn { padding: 15px; border-bottom: 1px solid #222; text-align: left; background: none; border: none; color: #888; cursor: pointer; font-weight: bold; }
    .season-btn-active { background: var(--accent) !important; color: black !important; }
    .episode-grid { flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; padding: 15px; overflow-y: auto; align-content: start; }
    .ep-card { background: #1a1a1a; border: 1px solid #333; border-radius: 8px; overflow: hidden; cursor: pointer; display: flex; flex-direction: column; height: 280px; }
    .ep-thumb { width: 100%; height: 160px; background: #000; flex-shrink: 0; }
    .ep-info { padding: 15px; font-size: 0.8rem; flex-grow: 1; display: flex; flex-direction: column; background: #1a1a1a; border-top: 2px solid #222; }
    .ep-info b { color: var(--accent); margin-bottom: 5px; display: block; }
    .player-block { width: 100%; max-width: var(--master-width); border-radius: 12px; overflow: hidden; border: 1px solid #333; background: #000; position: relative; }
    .now-playing { width: 100%; background: #1a1a1a; padding: 12px 20px; border-bottom: 1px solid #333; display: none; align-items: center; justify-content: space-between; }
    .vlc-btn { background: #f39c12; color: white; padding: 6px 15px; border-radius: 4px; font-size: 0.7rem; font-weight: bold; border: none; cursor: pointer; }
    video { width: 100%; display: block; aspect-ratio: 16/9; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Prabh's IPTV Master</h1>
    <div class="controls">
        <button id="btn-channels" onclick="fetchCategories('channels')">LIVE</button>
        <button id="btn-vod" onclick="fetchCategories('vod')">MOVIES</button>
        <button id="btn-series" onclick="fetchCategories('series')">SERIES</button>
        <select id="cat-select" onchange="loadCategoryData()"><option value="">-- Category --</option></select>
        <div class="search-wrapper"><input type="text" id="search" placeholder="Search..." oninput="handleSearch()"><span class="clear-btn" id="clear-search" onclick="clearSearch()">×</span></div>
    </div>
    <div id="list">Ready.</div>
    <div class="player-block">
        <div class="now-playing" id="playing-bar">
            <div>PLAYING: <span id="playing-title" style="color:var(--accent); font-weight:bold;"></span></div>
            <button onclick="copyVlcLink()" class="vlc-btn">OPEN IN VLC (FOR SOUND FIX)</button>
        </div>
        <div style="position: relative;">
            <div class="video-overlay" id="loader-overlay"><div class="percent-text" id="load-percent">0%</div></div>
            <video id="video" controls autoplay></video>
        </div>
    </div>
  </div>
  <script>
    let hls = null, allData = [], currentType = '', lastUrl = '', currentSeriesInfo = null;
    const listDiv = document.getElementById('list'), video = document.getElementById('video'), loaderOverlay = document.getElementById('loader-overlay'), loadPercent = document.getElementById('load-percent'), searchInput = document.getElementById('search'), clearBtn = document.getElementById('clear-search');

    const imageObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => { if (entry.isIntersecting) { const img = entry.target; img.src = img.dataset.src; img.onload = () => img.classList.add('loaded'); } });
    });

    video.addEventListener('waiting', () => { loaderOverlay.style.display = 'flex'; });
    video.addEventListener('playing', () => { loaderOverlay.style.display = 'none'; });
    video.addEventListener('progress', () => {
        if (video.duration > 0) {
            for (let i = 0; i < video.buffered.length; i++) {
                if (video.buffered.start(i) <= video.currentTime && video.buffered.end(i) >= video.currentTime) {
                    const percent = (video.buffered.end(i) / video.duration) * 100;
                    loadPercent.innerText = Math.min(100, Math.round(percent)) + "%";
                }
            }
        }
    });

    async function fetchCategories(type) {
        currentType = type;
        const buttons = { 'channels': 'btn-channels', 'vod': 'btn-vod', 'series': 'btn-series' };
        Object.values(buttons).forEach(id => document.getElementById(id).classList.remove('btn-active'));
        document.getElementById(buttons[type]).classList.add('btn-active');
        const res = await fetch(`/api/categories/${type}`);
        const cats = await res.json();
        document.getElementById('cat-select').innerHTML = `<option value="all">-- ALL CONTENT --</option>` + cats.map(c => `<option value="${c.category_id}">${c.category_name}</option>`).join('');
    }

    async function loadCategoryData() {
        const res = await fetch(`/api/list/${currentType}/${document.getElementById('cat-select').value}`);
        allData = await res.json(); renderList(allData);
    }

    function handleSearch() {
        const val = searchInput.value.trim();
        clearBtn.style.display = val.length > 0 ? 'block' : 'none';
        renderList(allData.filter(i => (i.name || i.title || "").toLowerCase().includes(val.toLowerCase())));
    }

    function clearSearch() { searchInput.value = ""; clearBtn.style.display = 'none'; renderList(allData); }

    function renderList(items) {
        listDiv.style.display = 'grid';
        const now = Math.floor(Date.now() / 1000);
        listDiv.innerHTML = items.map(i => {
            const id = i.series_id || i.stream_id;
            const name = i.name || i.title || "Untitled";
            let icon = (i.stream_icon || i.cover || '').includes('webhop.live') ? '' : (i.stream_icon || i.cover || '');
            const ext = i.container_extension || 'mp4';
            const action = currentType === 'series' ? `openSeries('${id}', '${name}')` : `play('${currentType === 'channels' ? 'live' : 'vod'}', '${id}', '${ext}', '${name}')`;
            return `<div class="item" onclick="${action}"><div class="poster-container"><img class="lazy" data-src="${icon}" onerror="this.style.display='none'"></div><div class="item-title">${name}</div></div>`;
        }).join('');
        document.querySelectorAll('img.lazy').forEach(img => imageObserver.observe(img));
    }

    async function openSeries(id, name) {
        const res = await fetch(`/api/series-info/${id}`); currentSeriesInfo = await res.json();
        listDiv.style.display = 'block'; renderSeriesUI(name);
    }

    function renderSeriesUI(name, selectedSeason = null) {
        const episodes = currentSeriesInfo.episodes || {}; const seasons = Object.keys(episodes); const activeSeason = selectedSeason || seasons[0];
        let html = `<div onclick="handleSearch()" style="background:#333;padding:15px;text-align:center;cursor:pointer;font-weight:bold;border-radius:12px 12px 0 0;">⬅ Back to Search Results</div><div class="series-container"><div class="season-sidebar">`;
        seasons.forEach(s => { html += `<button class="season-btn ${s === activeSeason ? 'season-btn-active' : ''}" onclick="renderSeriesUI('${name}', '${s}')">SEASON ${s}</button>`; });
        html += `</div><div class="episode-grid">`;
        (episodes[activeSeason] || []).forEach(ep => {
            const ext = ep.container_extension || 'mp4';
            html += `<div class="ep-card" onclick="play('vod', '${ep.id}', '${ext}', '${name} - E${ep.episode_num}')"><div class="ep-thumb"><img class="lazy" data-src="${ep.info && ep.info.movie_image ? ep.info.movie_image : ''}" onerror="this.style.display='none'"></div><div class="ep-info"><b>E${ep.episode_num}:</b> <span>${ep.title || 'Episode'}</span></div></div>`;
        });
        listDiv.innerHTML = html + `</div></div>`;
        document.querySelectorAll('img.lazy').forEach(img => imageObserver.observe(img));
    }

    function play(mode, id, ext, title) {
        document.getElementById('playing-bar').style.display = 'flex';
        document.getElementById('playing-title').innerText = title;

        if (hls) { hls.destroy(); hls = null; }
        video.pause(); video.removeAttribute('src'); video.load();

        if (mode === 'live') {
            // Live: Use manifest generator
            lastUrl = `${window.location.origin}/live/${id}.m3u8`;
            if (Hls.isSupported()) {
                hls = new Hls();
                hls.loadSource(lastUrl);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = lastUrl;
                video.play();
            }
        } else {
            // VOD: Use direct pipe
            lastUrl = `${window.location.origin}/stream/vod/${id}.${ext}`;
            video.src = lastUrl;
            video.play().catch(e => console.error("VOD Play Error:", e));
        }
    }

    function copyVlcLink() { navigator.clipboard.writeText(lastUrl); alert("Copied!"); }
  </script>
</body>
</html>